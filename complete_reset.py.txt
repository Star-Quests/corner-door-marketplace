import os
import sqlite3
from werkzeug.security import generate_password_hash

def complete_reset():
    print("üîÑ COMPLETE DATABASE RESET...")
    
    # Delete existing database
    if os.path.exists('corner_door.db'):
        os.remove('corner_door.db')
        print("üóëÔ∏è Old database deleted")
    
    # Create new database
    conn = sqlite3.connect('corner_door.db')
    cursor = conn.cursor()
    
    # Create tables
    cursor.execute('''
        CREATE TABLE user (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username VARCHAR(80) UNIQUE NOT NULL,
            password_hash VARCHAR(120) NOT NULL,
            recovery_phrase VARCHAR(200),
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            is_active BOOLEAN DEFAULT TRUE,
            is_admin BOOLEAN DEFAULT FALSE,
            ip_hash VARCHAR(64),
            unread_notifications INTEGER DEFAULT 0
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE product (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title VARCHAR(200) NOT NULL,
            description TEXT,
            price_usd FLOAT NOT NULL,
            crypto_type VARCHAR(10) NOT NULL,
            image_filename VARCHAR(200),
            is_active BOOLEAN DEFAULT TRUE,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            admin_rating INTEGER DEFAULT 5,
            allow_user_ratings BOOLEAN DEFAULT TRUE
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE wallet (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            crypto_type VARCHAR(10) NOT NULL,
            address VARCHAR(200) NOT NULL,
            is_active BOOLEAN DEFAULT TRUE
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE "order" (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            product_id INTEGER NOT NULL,
            crypto_type VARCHAR(10) NOT NULL,
            wallet_address VARCHAR(200) NOT NULL,
            crypto_amount FLOAT,
            user_paid BOOLEAN DEFAULT FALSE,
            admin_paid BOOLEAN DEFAULT FALSE,
            delivery_location TEXT,
            delivery_file VARCHAR(500),
            delivery_notes TEXT,
            user_rating INTEGER,
            user_review TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES user (id),
            FOREIGN KEY (product_id) REFERENCES product (id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE notification (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            message TEXT NOT NULL,
            is_read BOOLEAN DEFAULT FALSE,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            order_id INTEGER,
            FOREIGN KEY (user_id) REFERENCES user (id),
            FOREIGN KEY (order_id) REFERENCES "order" (id)
        )
    ''')
    
    # CART TABLES
    cursor.execute('''
        CREATE TABLE cart (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES user (id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE cart_item (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            cart_id INTEGER NOT NULL,
            product_id INTEGER NOT NULL,
            quantity INTEGER DEFAULT 1,
            added_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (cart_id) REFERENCES cart (id),
            FOREIGN KEY (product_id) REFERENCES product (id),
            UNIQUE(cart_id, product_id)
        )
    ''')
    
    # Create admin user (ACTIVE)
    cursor.execute('''
        INSERT INTO user (username, password_hash, is_admin, is_active, recovery_phrase)
        VALUES (?, ?, 1, 1, ?)
    ''', ('admin', generate_password_hash('admin123'), 'initial admin account - DO NOT DEACTIVATE'))
    
    # Create backup admin (HIDDEN)
    cursor.execute('''
        INSERT INTO user (username, password_hash, is_admin, is_active, recovery_phrase)
        VALUES (?, ?, 1, 1, ?)
    ''', ('superadmin', generate_password_hash('superadmin123'), 'emergency backup admin'))
    
    # Create primary admin account
    cursor.execute('''
        INSERT INTO user (username, password_hash, is_admin, is_active, recovery_phrase)
        VALUES (?, ?, 1, 1, ?)
    ''', ('corner', generate_password_hash('cornerdooradmin4life'), 'primary admin account'))
    
    # Create sample products
    cursor.execute('''
        INSERT INTO product (title, description, price_usd, crypto_type, admin_rating)
        VALUES (?, ?, ?, ?, ?)
    ''', ('Premium Digital Product', 'High-quality digital product with instant delivery', 99.99, 'BTC', 5))
    
    cursor.execute('''
        INSERT INTO product (title, description, price_usd, crypto_type, admin_rating)
        VALUES (?, ?, ?, ?, ?)
    ''', ('Crypto Trading Course', 'Complete guide to cryptocurrency trading strategies', 149.99, 'ETH', 4))
    
    cursor.execute('''
        INSERT INTO product (title, description, price_usd, crypto_type, admin_rating)
        VALUES (?, ?, ?, ?, ?)
    ''', ('NFT Art Collection', 'Exclusive digital art NFT collection', 49.99, 'SOL', 5))
    
    # Create sample wallets
    cursor.execute('''
        INSERT INTO wallet (crypto_type, address)
        VALUES (?, ?)
    ''', ('BTC', 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh'))
    
    cursor.execute('''
        INSERT INTO wallet (crypto_type, address)
        VALUES (?, ?)
    ''', ('ETH', '0x742d35Cc6634C0532925a3b8D6B6e7a5b5d7a5E5'))
    
    cursor.execute('''
        INSERT INTO wallet (crypto_type, address)
        VALUES (?, ?)
    ''', ('SOL', 'So11111111111111111111111111111111111111112'))
    
    conn.commit()
    
    # Verify creation
    cursor.execute("SELECT COUNT(*) FROM user")
    user_count = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM product")
    product_count = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM wallet")
    wallet_count = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM cart")
    cart_count = cursor.fetchone()[0]
    
    conn.close()
    
    print("‚úÖ DATABASE RESET COMPLETE!")
    print(f"üìä Created: {user_count} users, {product_count} products, {wallet_count} wallets, {cart_count} cart tables")
    print("\nüìã LOGIN CREDENTIALS:")
    print("   üë§ Primary Admin: corner / cornerdooradmin4life")
    print("   üë§ Backup Admin: admin / admin123")
    print("   üë§ Emergency Admin: superadmin / superadmin123")
    print("\nüõí Shopping cart system READY!")
    print("‚ö†Ô∏è  Keep the backup admin credentials safe!")

if __name__ == '__main__':
    complete_reset()